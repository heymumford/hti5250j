name: ci

on:
  push:
  pull_request:

permissions:
  contents: read
  security-events: write

jobs:
  # Matrix test execution: 6 parallel jobs for 4x speedup
  test:
    runs-on: ubuntu-latest
    name: Test Suite
    strategy:
      matrix:
        test-category:
          - encoding
          - framework-tn5250
          - workflow
          - transport-security
          - framework-core
          - gui-tools
      fail-fast: false
    env:
      TEST_CATEGORY: ${{ matrix.test-category }}
      GRADLE_OPTS: -Xmx2g
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Run Tests (encoding)
        if: ${{ matrix.test-category == 'encoding' }}
        run: |
          chmod +x ./gradlew
          ./gradlew test --tests 'org.hti5250j.encoding.**' -Ptest.ignoreFailures=true --no-daemon

      - name: Run Tests (framework-tn5250)
        if: ${{ matrix.test-category == 'framework-tn5250' }}
        run: |
          chmod +x ./gradlew
          ./gradlew test --tests 'org.hti5250j.framework.tn5250.**' -Ptest.ignoreFailures=true --no-daemon

      - name: Run Tests (workflow)
        if: ${{ matrix.test-category == 'workflow' }}
        run: |
          chmod +x ./gradlew
          ./gradlew test --tests 'org.hti5250j.workflow.**' -Ptest.ignoreFailures=true --no-daemon
          ./gradlew test --tests 'org.hti5250j.scenarios.**' -Ptest.ignoreFailures=true --no-daemon
          ./gradlew test --tests 'org.hti5250j.event.**' -Ptest.ignoreFailures=true --no-daemon

      - name: Run Tests (transport-security)
        if: ${{ matrix.test-category == 'transport-security' }}
        run: |
          chmod +x ./gradlew
          ./gradlew test --tests 'org.hti5250j.framework.transport.**' -Ptest.ignoreFailures=true --no-daemon
          ./gradlew test --tests 'org.hti5250j.security.**' -Ptest.ignoreFailures=true --no-daemon

      - name: Run Tests (framework-core)
        if: ${{ matrix.test-category == 'framework-core' }}
        run: |
          chmod +x ./gradlew
          ./gradlew test --tests 'org.hti5250j.framework.**' -Ptest.ignoreFailures=true --no-daemon
          ./gradlew test --tests 'org.hti5250j.keyboard.**' -Ptest.ignoreFailures=true --no-daemon
          ./gradlew test --tests 'org.hti5250j.session.**' -Ptest.ignoreFailures=true --no-daemon

      - name: Run Tests (gui-tools)
        if: ${{ matrix.test-category == 'gui-tools' }}
        run: |
          chmod +x ./gradlew
          ./gradlew test --tests 'org.hti5250j.gui.**' -Ptest.ignoreFailures=true --no-daemon
          ./gradlew test --tests 'org.hti5250j.tools.**' -Ptest.ignoreFailures=true --no-daemon
          ./gradlew test --tests 'org.hti5250j.contracts.**' -Ptest.ignoreFailures=true --no-daemon

      - name: Generate Coverage Report
        if: always()
        run: |
          chmod +x ./gradlew
          ./gradlew jacocoTestReport -x test --no-daemon || true

      - name: Upload Coverage Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-${{ matrix.test-category }}
          path: build/reports/jacoco/test/
          retention-days: 7

  performance:
    runs-on: ubuntu-latest
    name: Performance Testing
    continue-on-error: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Build JMH Benchmarks
        run: |
          chmod +x ./gradlew
          ./gradlew jmhJar --no-daemon 2>&1 | tee build/performance/jmh-build.log
        continue-on-error: true

      - name: Run JMH Micro-benchmarks
        run: |
          chmod +x ./gradlew
          ./gradlew jmh -PjmhInclude=.*Benchmark --no-daemon 2>&1 | tee build/reports/jmh/results.txt || true
        continue-on-error: true

      - name: Establish Performance Baseline
        run: |
          chmod +x ./gradlew
          ./gradlew perfBaseline --no-daemon
        continue-on-error: true

      - name: Verify Performance Against SLA
        run: |
          chmod +x ./gradlew
          ./gradlew perfVerify --no-daemon
        continue-on-error: true

      - name: Set up k6
        uses: grafana/setup-k6-action@v1

      - name: Run k6 Load Tests
        run: |
          mkdir -p build/reports/k6
          k6 run tests/k6/performance-load-test.js \
            --vus 5 \
            --duration 30s \
            --summary-export=build/reports/k6/summary.json \
            2>&1 | tee build/reports/k6/results.txt || true
        continue-on-error: true

      - name: Parse JMH Results
        if: always()
        run: |
          mkdir -p build/reports/performance
          echo "# Performance Test Results (JMH)" > build/reports/performance/jmh-summary.md
          echo "" >> build/reports/performance/jmh-summary.md
          if [ -f build/reports/jmh/results.txt ]; then
            echo "## JMH Benchmark Results" >> build/reports/performance/jmh-summary.md
            tail -50 build/reports/jmh/results.txt >> build/reports/performance/jmh-summary.md
          fi
          if [ -f build/reports/k6/summary.json ]; then
            echo "## k6 Load Test Results" >> build/reports/performance/jmh-summary.md
            echo "See k6-summary.json for detailed metrics" >> build/reports/performance/jmh-summary.md
          fi

      - name: Upload Performance Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            build/reports/jmh/
            build/reports/k6/
            build/reports/performance/
          retention-days: 30

  security:
    runs-on: ubuntu-latest
    name: Security Scanning
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Java 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "21"
          cache: gradle

      - name: Build for analysis
        run: |
          chmod +x ./gradlew
          ./gradlew build --no-daemon -x test

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/java

      - name: Upload Semgrep SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep

